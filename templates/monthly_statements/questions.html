{% extends "base.html" %}

{% set show_header = true %}

{% block header %}Monthly Statement Questions{% endblock %}

{% block content %}
<div class="upload-container">
    <div class="question-header">
        <h3>Question {{ question_state.current }} of {{ question_state.total }}</h3>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ (question_state.current / question_state.total * 100) }}%"></div>
        </div>
    </div>

    <div class="question-content">
        <h4>Is "{{ question_state.company_name }}" similar to "{{ question_state.similar_to }}"?</h4>
        <p>This will help us categorize the statement correctly.</p>
    </div>

    <div class="question-buttons">
        <button onclick="answerQuestion('y')" class="btn btn-primary">Yes</button>
        <button onclick="answerQuestion('n')" class="btn">No</button>
        <button onclick="answerQuestion('s')" class="btn">Skip All Remaining</button>
        {% if question_state.can_go_back %}
        <button onclick="answerQuestion('p')" class="btn">Previous</button>
        {% endif %}
    </div>

    <div id="message-section"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
function answerQuestion(response) {
    const formData = new FormData();
    formData.append('response', response);
    
    fetch('{{ url_for("monthly_statements.answer_question", session_id=session_id) }}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showMessage(data.error, 'error');
        } else if (data.status === 'completed') {
            showMessage('All questions completed! Processing PDFs... This may take several minutes for large files.', 'success');
            
            // Show a progress indicator
            const progressDiv = document.createElement('div');
            progressDiv.innerHTML = `
                <div class="progress-bar" style="margin-top: 10px;">
                    <div class="progress-fill" style="width: 0%; animation: pulse 1.5s infinite;"></div>
                </div>
                <p style="text-align: center; margin-top: 5px; font-size: 11px;">Please wait while we process your documents...</p>
            `;
            document.getElementById('message-section').appendChild(progressDiv);
            
            // Longer timeout for large file processing
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 3000);
        } else {
            // Reload page to show next question
            location.reload();
        }
    })
    .catch(error => {
        showMessage('Error: ' + error.message, 'error');
    });
}

function showMessage(text, type) {
    const messageSection = document.getElementById('message-section');
    messageSection.innerHTML = `<div class="message ${type}">${text}</div>`;
}
</script>
{% endblock %}