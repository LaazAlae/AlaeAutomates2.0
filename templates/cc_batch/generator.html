{% extends "base.html" %}

{% set show_header = true %}

{% block header %}Credit Card Batch Processing{% endblock %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
    
    <!-- SECTION 1: EXCEL FILE UPLOAD -->
    <div class="help-section">
        <div class="help-header">1. Upload Raw Excel File</div>
        <div class="help-content active">
            <p><strong>New Simplified Process:</strong> Upload your raw Excel file directly - no need to run macros manually!</p>
            
            <div class="upload-area" id="upload-area" style="border: 2px dashed #ccc; padding: 40px; text-align: center; margin: 20px 0; border-radius: 8px; background: #f9f9f9;">
                <p style="margin: 10px 0; color: #666;">Drag and drop your Excel file here, or click to select</p>
                <input type="file" id="excel-input" accept=".xlsx,.xls" style="display: none;">
                <button type="button" class="btn" onclick="document.getElementById('excel-input').click()">
                    Select Excel File
                </button>
            </div>
            
            <div id="file-info" style="display: none; margin: 15px 0; padding: 10px; background: #e8f4f8; border-radius: 4px;">
                <p style="margin: 0;"><strong>Selected file:</strong> <span id="file-name"></span></p>
                <button type="button" class="btn" id="process-btn" onclick="processExcel()" style="margin-top: 10px;">
                    Process Excel File
                </button>
            </div>
            
            <div id="processing-status" style="display: none; margin: 15px 0; padding: 15px; background: #fff3cd; border-radius: 4px;">
                <p style="margin: 0;">Processing your Excel file...</p>
            </div>
        </div>
    </div>

    <!-- SECTION 2: PROCESSED DATA PREVIEW -->
    <div class="help-section" id="preview-section" style="display: none;">
        <div class="help-header">2. Processed Data Preview</div>
        <div class="help-content active">
            <div id="data-summary" style="margin-bottom: 15px;"></div>
            <div id="data-preview"></div>
        </div>
    </div>

    <!-- SECTION 3: GENERATED JAVASCRIPT CODE -->
    <div class="help-section" id="code-section" style="display: none;">
        <div class="help-header">3. Generated Automation Code</div>
        <div class="help-content active">
            <div class="alert" style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; margin: 15px 0; border-radius: 4px;">
                <strong>Ready to use!</strong> Your JavaScript automation code has been generated.
            </div>
            
            <div style="margin: 20px 0;">
                <h4>How to use:</h4>
                <ol style="margin: 10px 0; padding-left: 25px;">
                    <li>Copy the code below</li>
                    <li>Navigate to your payment processing website</li>
                    <li>Open browser console (Press F12)</li>
                    <li>Paste and press Enter</li>
                    <li>Type <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px;">run()</code> to process each entry</li>
                </ol>
            </div>
            
            <div style="margin: 20px 0;">
                <button class="btn" onclick="copyToClipboard()" id="copy-btn">Copy Code to Clipboard</button>
                <button class="btn" onclick="downloadCode()" id="download-btn" style="margin-left: 10px;">Download as .js File</button>
            </div>
            
            <div id="generated-code" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin: 20px 0; font-family: 'Courier New', monospace; font-size: 12px; max-height: 400px; overflow-y: auto; white-space: pre-wrap;"></div>
        </div>
    </div>

    <!-- SECTION 4: USAGE INSTRUCTIONS -->
    <div class="help-section" id="instructions-section" style="display: none;">
        <div class="help-header">4. Usage Instructions</div>
        <div class="help-content active">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div>
                    <h4>Automation Features:</h4>
                    <ul style="margin: 10px 0; padding-left: 25px;">
                        <li>Auto-detects current page</li>
                        <li>Auto-fills all form fields</li>
                        <li>Handles multiple invoice formats</li>
                        <li>Skips refund entries automatically</li>
                        <li>Processes BILL.COM entries correctly</li>
                        <li>Tracks progress automatically</li>
                    </ul>
                </div>
                <div>
                    <h4>Console Commands:</h4>
                    <ul style="margin: 10px 0; padding-left: 25px;">
                        <li><code>run()</code> - Process next entry</li>
                        <li><code>reset()</code> - Start from first record</li>
                        <li>View progress in console</li>
                        <li>Error handling included</li>
                    </ul>
                </div>
            </div>
            
            <div class="alert" style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; margin: 15px 0; border-radius: 4px;">
                <strong>Important:</strong> The automation handles all the complex logic from your VBA macro including:
                <ul style="margin: 10px 0; padding-left: 25px;">
                    <li>Removing XXXX prefixes from card numbers</li>
                    <li>Converting A/V/M/D to AMEX/VISA/MC/DISC</li>
                    <li>Handling lastname, firstname format</li>
                    <li>Skipping refund entries (amounts in parentheses)</li>
                    <li>Managing multiple invoice numbers per line</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
let processedData = [];
let generatedCode = '';

// File input handling
document.getElementById('excel-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-info').style.display = 'block';
        
        // Reset previous results
        document.getElementById('preview-section').style.display = 'none';
        document.getElementById('code-section').style.display = 'none';
        document.getElementById('instructions-section').style.display = 'none';
    }
});

// Drag and drop handling
const uploadArea = document.getElementById('upload-area');
uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#007bff';
    uploadArea.style.background = '#e3f2fd';
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#ccc';
    uploadArea.style.background = '#f9f9f9';
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#ccc';
    uploadArea.style.background = '#f9f9f9';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        document.getElementById('excel-input').files = files;
        document.getElementById('file-name').textContent = files[0].name;
        document.getElementById('file-info').style.display = 'block';
    }
});

// Process Excel file
function processExcel() {
    const fileInput = document.getElementById('excel-input');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select an Excel file first.');
        return;
    }
    
    // Show processing status
    document.getElementById('processing-status').style.display = 'block';
    document.getElementById('process-btn').disabled = true;
    
    // Create form data
    const formData = new FormData();
    formData.append('excel_file', file);
    
    // Send to server for processing
    fetch('/cc_batch/process', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('processing-status').style.display = 'none';
        document.getElementById('process-btn').disabled = false;
        
        if (data.success) {
            processedData = data.processed_data;
            generatedCode = data.javascript_code;
            
            showDataPreview(data.records_count, data.processed_data);
            showGeneratedCode(data.javascript_code);
            showInstructions();
        } else {
            alert('Error processing file: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        document.getElementById('processing-status').style.display = 'none';
        document.getElementById('process-btn').disabled = false;
        console.error('Error:', error);
        alert('Error processing file. Please check the console for details.');
    });
}

function showDataPreview(recordCount, previewData) {
    document.getElementById('data-summary').innerHTML = 
        `<div class="alert" style="background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 4px;">
            <strong>Processing Complete!</strong> Successfully processed ${recordCount} payment records.
        </div>`;
    
    if (previewData && previewData.length > 0) {
        let html = '<h4>Preview (first 5 records):</h4>';
        html += '<table class="data-table" style="width: 100%; border-collapse: collapse; margin: 15px 0;">';
        html += '<thead><tr style="background: #f8f9fa;"><th style="padding: 10px; border: 1px solid #dee2e6;">Invoice</th><th style="padding: 10px; border: 1px solid #dee2e6;">Payment Method</th><th style="padding: 10px; border: 1px solid #dee2e6;">Amount</th><th style="padding: 10px; border: 1px solid #dee2e6;">Customer</th></tr></thead><tbody>';
        
        previewData.forEach(record => {
            html += '<tr>';
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${record.invoice}</td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${record.payment_method}</td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;">$${record.amount}</td>`;
            html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${record.customer}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        document.getElementById('data-preview').innerHTML = html;
    }
    
    document.getElementById('preview-section').style.display = 'block';
}

function showGeneratedCode(code) {
    document.getElementById('generated-code').textContent = code;
    document.getElementById('code-section').style.display = 'block';
}

function showInstructions() {
    document.getElementById('instructions-section').style.display = 'block';
}

function copyToClipboard() {
    navigator.clipboard.writeText(generatedCode).then(function() {
        const btn = document.getElementById('copy-btn');
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(function() {
            btn.textContent = originalText;
        }, 2000);
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
        // Fallback
        const textArea = document.createElement('textarea');
        textArea.value = generatedCode;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const btn = document.getElementById('copy-btn');
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(function() {
            btn.textContent = originalText;
        }, 2000);
    });
}

function downloadCode() {
    fetch('/cc_batch/download-code', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ code: generatedCode })
    })
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'cc_batch_automation.js';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    })
    .catch(error => {
        console.error('Error downloading file:', error);
        alert('Error downloading file. Please copy the code manually.');
    });
}
</script>
{% endblock %}